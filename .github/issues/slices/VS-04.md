---
title: "VS-04: Calculate Result (Command Slice - Order of Operations)"
labels:
  [
    "slice:foundation",
    "priority:P0",
    "type:command",
    "phase:mvp",
    "risk:medium",
  ]
assignees: []
---

## Overview

**Slice Type:** Command (State Modification)
**Priority:** P0 (Critical)
**Effort:** 8 hours
**Risk:** Medium (complex logic, edge cases)
**Dependencies:** VS-01 (Display), VS-02 (Input), VS-03 (Operation)

Implement the equals button to execute pending calculations and display results with correct precision.

## User Story

```
As a user
I want to press equals to see the result of my calculation
So that I can obtain the answer to my arithmetic problem
```

## Acceptance Criteria

- [ ] Equals button (=) executes the pending calculation
- [ ] Result is mathematically correct for all operations
- [ ] Division by zero displays error message
- [ ] Result maintains decimal precision up to 10 places
- [ ] Handles negative results correctly
- [ ] Handles large numbers up to 15 digits
- [ ] Floating point accuracy for 0.1 + 0.2 = 0.3
- [ ] Enter key triggers calculation
- [ ] Result can be used as input for next calculation (chaining)
- [ ] PEMDAS order of operations for single operation

## Technical Requirements

**HTML Structure:**

```html
<button class="btn btn--equals" id="equalsBtn">=</button>
```

**State Modification:**

- Reads: `calculatorState.previousValue`
- Reads: `calculatorState.currentValue`
- Reads: `calculatorState.operation`
- Modifies: `calculatorState.currentValue` (stores result)
- Modifies: `calculatorState.previousValue` (clears)
- Modifies: `calculatorState.operation` (clears)
- Modifies: `calculatorState.awaitingOperand` (sets to true)
- Modifies: `calculatorState.displayError` (sets on error)

**Business Logic - Calculation Engine:**

```javascript
function calculate(previousValue, currentValue, operation) {
  const prev = parseFloat(previousValue);
  const current = parseFloat(currentValue);

  if (isNaN(prev) || isNaN(current)) {
    return { error: true, message: "Invalid input" };
  }

  let result;
  switch (operation) {
    case "+":
      result = prev + current;
      break;
    case "-":
      result = prev - current;
      break;
    case "*":
      result = prev * current;
      break;
    case "/":
      if (current === 0) {
        return { error: true, message: "Cannot divide by zero" };
      }
      result = prev / current;
      break;
    default:
      return { error: true, message: "Unknown operation" };
  }

  // Round to 10 decimal places to handle floating point precision
  result = Math.round(result * 10000000000) / 10000000000;

  // Check maximum digit length
  if (result.replace(".", "").replace("-", "").length > 15) {
    result = parseFloat(result).toExponential(10);
  }

  return { error: false, result: result.toString() };
}
```

**Floating Point Precision:**

- Critical requirement: 0.1 + 0.2 must equal 0.3
- Implementation: Round to 10 decimal places
- Fallback: Consider decimal.js library if issues persist

## Test Requirements

- Unit tests for all operations (15+ test cases)
- Integration tests for complete workflows
- Edge case testing (division by zero, floating point precision)

### Critical Test Cases

| Test Case | Operation | Expected Result                | Priority |
| --------- | --------- | ------------------------------ | -------- |
| TC-V4-01  | 5 + 3     | 8                              | High     |
| TC-V4-02  | 10 - 4    | 6                              | High     |
| TC-V4-03  | 7 ร 6     | 42                             | High     |
| TC-V4-04  | 20 รท 4    | 5                              | High     |
| TC-V4-05  | 10 รท 0    | Error: "Cannot divide by zero" | Critical |
| TC-V4-06  | 0.1 + 0.2 | 0.3 (not 0.30000000000000004)  | Critical |
| TC-V4-07  | 5 - 10    | -5                             | High     |

## Implementation Checklist

- [ ] Create HTML equals button
- [ ] Implement `calculate()` function
- [ ] Add all four arithmetic operations
- [ ] Implement floating point precision handling
- [ ] Add division by zero error handling
- [ ] Add scientific notation for large numbers
- [ ] Add keyboard event listener for Enter key
- [ ] Implement result chaining logic
- [ ] Write unit tests for all operations
- [ ] Write unit tests for edge cases
- [ ] Write integration tests for complete workflows
- [ ] Test floating point precision extensively
